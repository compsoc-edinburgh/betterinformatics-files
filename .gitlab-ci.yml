variables:
  VIS_CI_APP_NAME: "community-solutions"
  VIS_CI_DEPLOYMENT_SUBDOMAIN: "exams"
  VIS_CI_ENABLE_POSTGRES: "true"
  VIS_CI_ENABLE_MINIO: "true"
  VIS_CI_LIVENESS_PROBE_PATH: "/health"
  VIS_CI_LIVENESS_PROBE_INITIAL_DELAY: 140
  VIS_CI_READINESS_PROBE_PATH: "/health"
  VIS_CI_READINESS_PROBE_INITIAL_DELAY: 120
  VIS_CI_SERVIS_DEPENDENCIES: "people-api"
  VIS_CI_SERVIS_PYTHON_OUT: "./backend/servis"

stages:
  - build
  - deploy
  - cleanup

build:
  tags:
    - docker-runner
  stage: build
  script:
    - do_servis_generate
    - do_default_build

deploy:
  tags:
    - docker-runner
  stage: deploy
  environment:
    name: $VIS_CI_APP_NAME-$CI_COMMIT_REF_NAME
    url: https://$VIS_CI_DEPLOYMENT_SUBDOMAIN.$VIS_CI_DEPLOYMENT_DOMAIN
  script:
    - do_deployment
  only:
    refs:
      - staging
      - production

cleanup:
  tags:
    - docker-runner
  stage: cleanup
  script:
    - do_cleanup
  when: manual
  only:
    refs:
      - staging
      - prod

.auto_devops: &auto_devops |
  export VIS_CI_HELM_EXTRA_ARGS="\
    --set envVariables[0].name=RUNTIME_COMMUNITY_SOLUTIONS_SESSION_SECRET \
    --set envVariables[0].secretName=community-solutions-session-secret \
    --set envVariables[0].secretKey=value\
    --set envVariables[1].name=RUNTIME_COMMUNITY_SOLUTIONS_API_KEY \
    --set envVariables[1].secretName=community-solutions-api-key \
    --set envVariables[1].secretKey=value\
    "
  git clone --depth 1 git@gitlab.ethz.ch:vis/cit/ci-framework.git
  source ci-framework/ciscript.sh

before_script:
  - docker info
  - *auto_devops
